clear allclose allcomputer = 'Macbook';% Calibration luminance values taken by Ruben van Bergen on% March 2, 2012, room lights off, factory default screen settings% [255 255 255] = (149+147)/2 = 148, check: 32.25+104.5+10.05 = 146.8	% black = (0.22+0.22)/2 = 0.22% luminances measured using photometer (descending order, 1 run, 2 measures per level)lum1 = [		0.22 0.68 2.06 4.51 8.10 12.6 18.5 25.8 32.4;... %Ra                0.22 1.73 6.50 14.7 26.6 41.7 61.0 84.7 105 ;... %Ga                0.22 0.37 0.74 1.41 2.39 3.67 5.35 7.49 10.1;... %Ba                ]';                lum2 = [		32.1 25.5 18.2 12.3 7.88 4.31 1.97 0.65 0.22;... %Rd                104  83.8 60.3 41.1 26.1 14.3 6.30 1.71 0.22;... %Gd                10.0 7.37 5.25 3.57 2.33 1.36 0.72 0.35 0.22;... %Bd                ]';                                lum = (lum1 + flipud(lum2))/2;voltage = kron([1 1 1], [0,32,64,96,128,160,192,224,255]'); 		% i.e. color number values, should be in ascending ordernormVolt = (voltage-voltage(1))/ (max(voltage(:)) - voltage(1));		% normalize to range 0 to 1    maxLum = max(lum);dacsize = 8;% threshold = min(lum)/max(lum)figurecolor = 'rgb';for n = 1:3	normLum(:,n) = (lum(:,n) - min(lum(:,n))) / (max(lum(:,n)) - min(lum(:,n)));			% normalize to range 0 to 1		% calculate gamma using threshold starting normVolt (leads to better fits) (i.e. MonitorGammaError)    a = normVolt(:,n);    b = normLum(:,n);    params=fminsearch(@(x) MonitorGammaError(x,a,b) ,[0.1 2]);% 	params=fminsearch('MonitorGammaError',[.1 2],[],[],normVolt(:,n), normLum(:,n));	threshold(n) = params(1);	gamma(n) = params(2);	fit(:,n) = MonitorGamma(normVolt(:,n),params(1),params(2));			% fit of specific voltages using gamma power function	gamTable(:,n) = MonitorGamma([0:255]'/255,params(1),params(2));		% table of fitted gamma values 	mse(n) = mean( (normLum(:,n) - fit(:,n)).^2);		plot(normVolt(:,n), normLum(:,n), [color(n) '*']);	hold on;	plot(normVolt(:,n), fit(:,n), [color(n) '-']);	hold on;		endgamInverse = mkInvGammaTable(gamTable,256*4);	% create inverse gamma table, note, 1st entry is 0 0 0, oversample gamma table												% very similar to InvertGammaTable.m in psychophysical toolbox except that [0 0 0]												% is first entry (rather than starting at much higher color number)% cd('Calibration')                                                dacsize = 8;												calibrationFile = ['calib_' date '.mat'];eval(['save ' calibrationFile ' lum voltage normLum normVolt gamma threshold gamTable gamInverse mse computer maxLum dacsize']);eval(['save calibrationNameFile calibrationFile']);% Function MonitorGamma uses gamma function y = x^g  where% x = input normVolt, y = normLuminance, % x0 = threshold normVolt before normLuminance starts to increase% fmins minimizes function MonitorGammaError (psychophysics toolbox) % which calculates mean squared error between % actual normLuminances as a function of normVolt and a gamma function specified in MonitorGamma% default starting values threshold = .1, gamma = 2% params(1) = threshold, params(2) = gamma		% calculate gamma using no threshold level for starting normVolt (leads to poorer fits) (i.e. MonitorGammaErrorFT)% params=fmins('MonitorGammaErrorFT',[.1 2],[],[],normVolt, normLum)% gamma = params(2)% fit = normVolt.^gamma% mse = mean( (normLum- fit).^2)% [fitvals] = FitGamma(255*normVolt',normLum',(0:255)','1');   % couldn't get this function to workfigure, plot(gamInverse)